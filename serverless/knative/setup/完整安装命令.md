istioctl install --set profile=demo -y
kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.1.0/serving-crds.yaml
kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.1.0/serving-core.yaml
kubectl apply -f https://github.com/knative/net-istio/releases/download/knative-v1.1.0/istio.yaml
kubectl apply -f https://github.com/knative/net-istio/releases/download/knative-v1.1.0/net-istio.yaml
kubectl get pods -n knative-serving

kubectl apply -f https://github.com/knative/eventing/releases/download/knative-v1.1.0/eventing-crds.yaml
kubectl apply -f https://github.com/knative/eventing/releases/download/knative-v1.1.0/eventing-core.yaml 

kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml


% kubectl -n knative-serving get pod    
NAME                                     READY   STATUS    RESTARTS   AGE
activator-7f97f884b-jq8n8                1/1     Running   0          29m
autoscaler-d959cc464-bgnhw               1/1     Running   0          29m
controller-5658dfcc57-kdbks              1/1     Running   0          28m
domain-mapping-fb9d95795-b9vlq           1/1     Running   0          28m
domainmapping-webhook-759fbd5cdb-2shcs   1/1     Running   0          28m
webhook-5468c9bd74-b66n8                 1/1     Running   0          27m


 % kubectl -n knative-eventing  get pod   
No resources found in knative-eventing namespace.

% kubectl -n knative-eventing  get deploy     
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
eventing-controller     0/1     0            0           30s
eventing-webhook        0/1     0            0           47s
pingsource-mt-adapter   0/0     0            0           4s

调整cpu 内存大小,不行，重新apply 下
% kubectl -n knative-eventing  get pod   
NAME                                   READY   STATUS    RESTARTS   AGE
eventing-controller-769868bd99-6frzh   1/1     Running   0          57s
eventing-webhook-65db7fcfb4-7j9dh      1/1     Running   0          44s

% kubectl -n tekton-pipelines  get pods
NAME                                           READY   STATUS             RESTARTS   AGE
tekton-pipelines-controller-778d9dd977-ntpvj   0/1     ImagePullBackOff   0          117m
tekton-pipelines-webhook-75979b577d-rj646      0/1     ImagePullBackOff   0          117m

% git submodule add https://github.com/knative/serving

% git submodule add  https://github.com/knative/eventing

 % git submodule add https://github.com/knative/docs 


https://github.com/knative/docs/tree/main/code-samples/serving


https://github.com/knative/docs/tree/main/code-samples/serving/hello-world/helloworld-go

 cd docs/code-samples/serving/hello-world/helloworld-go 

% kubectl create ns knative-go
namespace/knative-go created

 % docker build -t xiazemin/knative-go/helloworld-go . 
 % docker push xiazemin/knative-go/helloworld-go

% kubectl apply -f  service.yaml 
service.serving.knative.dev/knative-go created

 % kubectl -n knative-go  get all
NAME                                      URL   READY   REASON
route.serving.knative.dev/helloworld-go                 

NAME                                        URL   LATESTCREATED   LATESTREADY   READY   REASON
service.serving.knative.dev/helloworld-go                                               

NAME                                               CONFIG NAME     K8S SERVICE NAME   GENERATION   READY   REASON   ACTUAL REPLICAS   DESIRED REPLICAS
revision.serving.knative.dev/helloworld-go-00001   helloworld-go                      1                                               

NAME                                              LATESTCREATED   LATESTREADY   READY   REASON
configuration.serving.knative.dev/helloworld-go   


% kubectl -n knative-go  get svc
No resources found in knative-go namespace.

%  kubectl  -n knative-go get ksvc
NAME            URL   LATESTCREATED   LATESTREADY   READY   REASON
helloworld-go                         

 kubectl  -n knative-go get ksvc helloworld-go  --output=custom-columns=NAME:.metadata.name,URL:.status.url


 https://knative.dev/docs/serving/services/private-services/





 To label a Knative Service:


kubectl label kservice ${KSVC_NAME} networking.knative.dev/visibility=cluster-local
By labeling the Kubernetes Service you can restrict visibility in a more fine-grained way. See Traffic management for information about tagged routes.

To label a Route when the Route is used directly without a Knative Service:


kubectl label route ${ROUTE_NAME} networking.knative.dev/visibility=cluster-local
To label a Kubernetes Service:


kubectl label service ${SERVICE_NAME} networking.knative.dev/visibility=cluster-local



kubectl -n knative-go label kservice helloworld-go networking.knative.dev/visibility=cluster-local

service.serving.knative.dev/helloworld-go labeled

%  kubectl  -n knative-go get ksvc helloworld-go
NAME            URL   LATESTCREATED   LATESTREADY   READY   REASON
helloworld-go                           

https://knative.dev/docs/install/serving/install-serving-with-yaml/


kubectl apply -l knative.dev/crd-install=true -f https://github.com/knative/net-istio/releases/download/knative-v1.1.0/istio.yaml
kubectl apply -f https://github.com/knative/net-istio/releases/download/knative-v1.1.0/istio.yaml


kubectl apply -f https://github.com/knative/net-istio/releases/download/knative-v1.1.0/net-istio.yaml


kubectl --namespace istio-system get service istio-ingressgateway


% kubectl apply -f  ../../../../../setup/net-istio.yaml   
clusterrole.rbac.authorization.k8s.io/knative-serving-istio unchanged
gateway.networking.istio.io/knative-ingress-gateway created
gateway.networking.istio.io/knative-local-gateway created
service/knative-local-gateway created
configmap/config-istio created
peerauthentication.security.istio.io/webhook created
peerauthentication.security.istio.io/domainmapping-webhook created
peerauthentication.security.istio.io/net-istio-webhook created
deployment.apps/net-istio-controller created
deployment.apps/net-istio-webhook created
secret/net-istio-webhook-certs created
service/net-istio-webhook created
mutatingwebhookconfiguration.admissionregistration.k8s.io/webhook.istio.networking.internal.knative.dev unchanged
validatingwebhookconfiguration.admissionregistration.k8s.io/config.webhook.istio.networking.internal.knative.dev unchanged


% kubectl get pods -n knative-serving
NAME                                     READY   STATUS              RESTARTS       AGE
activator-7f97f884b-jq8n8                1/1     Running             1 (118m ago)   3h5m
autoscaler-d959cc464-bgnhw               1/1     Running             1 (118m ago)   3h5m
controller-5658dfcc57-kdbks              1/1     Running             2 (117m ago)   3h4m
domain-mapping-fb9d95795-b9vlq           1/1     Running             2 (117m ago)   3h4m
domainmapping-webhook-759fbd5cdb-2shcs   1/1     Running             4 (49m ago)    3h3m
net-istio-controller-65685496f8-8tctt    0/1     ErrImagePull        0              33s
net-istio-webhook-5588bc847f-r87mj       0/1     ContainerCreating   0              32s
webhook-5468c9bd74-b66n8                 1/1     Running             3 (13m ago)    3h3m

 % kubectl -n knative-serving get deploy net-istio-controller -o yaml > net-istio-controller.yaml  

 % kubectl -n knative-serving get deploy net-istio-webhook -o yaml > net-istio-webhook.yaml


 % docker pull xunfeng/net-istio-controller:v0.17.3
v0.17.3: Pulling from xunfeng/net-istio-controller
4000adbbc3eb: Pull complete 
3c2cba919283: Pull complete 
ecd0db100834: Pull complete 
7b4c9d5f7c65: Pull complete 
Digest: sha256:441e51baeec54a0dd66200097c1bd1b14a58f4dc22dea6b82bb2cf729e797357
Status: Downloaded newer image for xunfeng/net-istio-controller:v0.17.3
docker.io/xunfeng/net-istio-controller:v0.17.3

% docker pull xunfeng/knative-net-istio-webhook:v0.25.2
v0.25.2: Pulling from xunfeng/knative-net-istio-webhook
b49b96595fd4: Already exists 
86772132e236: Pull complete 
686944d6e112: Pull complete 
Digest: sha256:0e5c3394253cf084998924d562503902d5dba5c5f52febc70a1fc5e4d4bc95f5
Status: Downloaded newer image for xunfeng/knative-net-istio-webhook:v0.25.2
docker.io/xunfeng/knative-net-istio-webhook:v0.25.2


 % kubectl -n knative-serving get deploy
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
activator               1/1     1            1           3h19m
autoscaler              1/1     1            1           3h19m
controller              1/1     1            1           3h19m
domain-mapping          1/1     1            1           3h18m
domainmapping-webhook   1/1     1            1           3h18m
net-istio-controller    1/1     1            1           19s
net-istio-webhook       1/1     1            1           44s
webhook                 1/1     1            1           3h18m

https://www.jianshu.com/p/c79faf206f74


%  kubectl  -n knative-go describe ksvc helloworld-go
  Warning  UpdateFailed  2m37s (x19 over 14m)  service-controller  Failed to update status for "helloworld-go": admission webhook "webhook.serving.knative.dev" denied the request: mutation failed: cannot decode incoming new object: json: unknown field "subresource"


% kn -n knative-go service create helloworld-go --image=xiazemin/knative-go/helloworld-go --env TARGET="Go Sample v1"
Error: cannot create service 'helloworld-go' in namespace 'knative-go' because the service already exists and no --force option was given
Run 'kn --help' for usage

kn -n knative-go service create helloworld-go-kn --image=xiazemin/knative-go/helloworld-go --env TARGET="Go Sample v1"


 % kn service describe helloworld-go-kn -n knative-go
Name:       helloworld-go-kn
Namespace:  knative-go
Age:        7m
URL:        

Revisions:  

Conditions:  
  OK TYPE    AGE REASON


 % docker pull busybox:1.28
1.28: Pulling from library/busybox
07a152489297: Pull complete 
Digest: sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47
Status: Downloaded newer image for busybox:1.28
docker.io/library/busybox:1.28


% kubectl apply -f ../setup/istio.yaml
Warning: resource namespaces/istio-system is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
namespace/istio-system configured
serviceaccount/istio-ingressgateway-service-account configured
serviceaccount/istio-reader-service-account configured
serviceaccount/istiod configured
serviceaccount/istiod-service-account configured
clusterrole.rbac.authorization.k8s.io/istio-reader-clusterrole-istio-system configured
clusterrole.rbac.authorization.k8s.io/istio-reader-istio-system configured
clusterrole.rbac.authorization.k8s.io/istiod-clusterrole-istio-system configured
clusterrole.rbac.authorization.k8s.io/istiod-gateway-controller-istio-system configured
clusterrole.rbac.authorization.k8s.io/istiod-istio-system configured
clusterrolebinding.rbac.authorization.k8s.io/istio-reader-clusterrole-istio-system configured
clusterrolebinding.rbac.authorization.k8s.io/istio-reader-istio-system configured
clusterrolebinding.rbac.authorization.k8s.io/istiod-clusterrole-istio-system configured
clusterrolebinding.rbac.authorization.k8s.io/istiod-gateway-controller-istio-system configured
clusterrolebinding.rbac.authorization.k8s.io/istiod-istio-system configured
role.rbac.authorization.k8s.io/istio-ingressgateway-sds configured
role.rbac.authorization.k8s.io/istiod configured
role.rbac.authorization.k8s.io/istiod-istio-system configured
rolebinding.rbac.authorization.k8s.io/istio-ingressgateway-sds configured
rolebinding.rbac.authorization.k8s.io/istiod configured
rolebinding.rbac.authorization.k8s.io/istiod-istio-system configured
customresourcedefinition.apiextensions.k8s.io/authorizationpolicies.security.istio.io configured
customresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io configured
customresourcedefinition.apiextensions.k8s.io/envoyfilters.networking.istio.io configured
customresourcedefinition.apiextensions.k8s.io/gateways.networking.istio.io configured
customresourcedefinition.apiextensions.k8s.io/istiooperators.install.istio.io configured
customresourcedefinition.apiextensions.k8s.io/peerauthentications.security.istio.io configured
customresourcedefinition.apiextensions.k8s.io/requestauthentications.security.istio.io configured
customresourcedefinition.apiextensions.k8s.io/serviceentries.networking.istio.io configured
customresourcedefinition.apiextensions.k8s.io/sidecars.networking.istio.io configured
customresourcedefinition.apiextensions.k8s.io/telemetries.telemetry.istio.io configured
customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io configured
customresourcedefinition.apiextensions.k8s.io/wasmplugins.extensions.istio.io configured
customresourcedefinition.apiextensions.k8s.io/workloadentries.networking.istio.io configured
customresourcedefinition.apiextensions.k8s.io/workloadgroups.networking.istio.io configured
configmap/istio configured
configmap/istio-sidecar-injector configured
deployment.apps/istio-ingressgateway configured
deployment.apps/istiod configured
service/istio-ingressgateway configured
service/istiod configured
Warning: autoscaling/v2beta1 HorizontalPodAutoscaler is deprecated in v1.22+, unavailable in v1.25+; use autoscaling/v2beta2 HorizontalPodAutoscaler
horizontalpodautoscaler.autoscaling/istiod created
Warning: policy/v1beta1 PodDisruptionBudget is deprecated in v1.21+, unavailable in v1.25+; use policy/v1 PodDisruptionBudget
poddisruptionbudget.policy/istio-ingressgateway configured
poddisruptionbudget.policy/istiod configured
mutatingwebhookconfiguration.admissionregistration.k8s.io/istio-sidecar-injector configured
validatingwebhookconfiguration.admissionregistration.k8s.io/istio-validator-istio-system configured
envoyfilter.networking.istio.io/stats-filter-1.10 configured
envoyfilter.networking.istio.io/stats-filter-1.11 configured
envoyfilter.networking.istio.io/stats-filter-1.12 configured
envoyfilter.networking.istio.io/tcp-stats-filter-1.10 configured
envoyfilter.networking.istio.io/tcp-stats-filter-1.11 configured
envoyfilter.networking.istio.io/tcp-stats-filter-1.12 configured


% kubectl -n istio-system describe pod istiod-6cf96f5669-vxmjs
  Warning  FailedScheduling  35s   default-scheduler  0/1 nodes are available: 1 Insufficient cpu.


% kubectl -n istio-system delete deploy istio-ingressgateway
deployment.apps "istio-ingressgateway" deleted

% kubectl -n istio-system delete deploy istiod  
deployment.apps "istiod" deleted

% kubectl -n istio-system delete deploy istio-egressgateway 
deployment.apps "istio-egressgateway" deleted

% kubectl apply -f ../setup/istio.yaml

 % kubectl -n istio-system get pods  NAME                                   READY   STATUS    RESTARTS   AGE
istio-ingressgateway-954f7945d-4hr4x   0/1     Pending   0          61s
istio-ingressgateway-954f7945d-hpqjq   1/1     Running   0          61s
istio-ingressgateway-954f7945d-zznxx   0/1     Pending   0          61s
istiod-6cf96f5669-h7q6d                1/1     Running   0          58s
istiod-6cf96f5669-lnzzw                0/1     Pending   0          58s
istiod-6cf96f5669-w8n9b                1/1     Running   0          61s


spec:
  replicas: 3

spec:
  replicas: 1


% kubectl -n istio-system get deploy
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istio-ingressgateway   1/1     1            1           54s
istiod                 1/1     1            1           54s


kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.1.0/serving-default-domain.yaml

 % docker pull shixiongqi/default-domain-dd6f55160290a90018ba318b624be12e:latest
latest: Pulling from shixiongqi/default-domain-dd6f55160290a90018ba318b624be12e
2df365faf0e3: Already exists 
72164b581b02: Already exists 
1d1d4c84e262: Pull complete 
Digest: sha256:d5237d3cd7532cae38abd0c19989765ca4f3612e4e8886e1a4491defe912bcd1
Status: Downloaded newer image for shixiongqi/default-domain-dd6f55160290a90018ba318b624be12e:latest
docker.io/shixiongqi/default-domain-dd6f55160290a90018ba318b624be12e:latest

% kubectl apply -f serving-default-domain.yaml 
job.batch/default-domain created
service/default-domain-service created

% kubectl -n knative-serving describe pod default-domain--1-sr6t9
 default-scheduler  0/1 nodes are available: 1 Insufficient cpu.



            limits:
              cpu: 1000m
              memory: 1000Mi

                          limits:
              cpu: 10m
              memory: 100Mi


% kubectl -n knative-serving get pods
NAME                                     READY   STATUS    RESTARTS      AGE
activator-7f97f884b-jq8n8                1/1     Running   2 (30m ago)   5h36m
autoscaler-d959cc464-bgnhw               1/1     Running   2 (30m ago)   5h36m
controller-5658dfcc57-kdbks              1/1     Running   4 (29m ago)   5h36m
default-domain--1-f7bgr                  1/1     Running   0             49s
domain-mapping-fb9d95795-b9vlq           1/1     Running   4 (29m ago)   5h35m
domainmapping-webhook-759fbd5cdb-2shcs   1/1     Running   6 (29m ago)   5h35m
net-istio-controller-786d478df-kzrkw     1/1     Running   2 (29m ago)   137m
net-istio-webhook-cc8d69b85-8jvl5        1/1     Running   1 (30m ago)   137m
webhook-5468c9bd74-b66n8                 1/1     Running   5 (29m ago)   5h35m


问题解决


% kubectl apply -f docs/code-samples/serving/hello-world/helloworld-go/service.yaml
service.serving.knative.dev/helloworld-go created


% kubectl  -n knative-go get ksvc helloworld-go  --output=custom-columns=NAME:.metadata.name,URL:.status.url
NAME            URL
helloworld-go   <none>

curl -H "Host: helloworld-go.knative-go.local" http://127.0.0.1

https://www.servicemesher.com/getting-started-with-knative/using-knative.html

https://sslip.io/

 % kubectl -n knative-go describe ksvc helloworld-go 
   Warning  UpdateFailed  2m54s (x21 over 15m)  service-controller  Failed to update status for "helloworld-go": admission webhook "webhook.serving.knative.dev" denied the request: mutation failed: cannot decode incoming new object: json: unknown field "subresource"

   https://zhuanlan.zhihu.com/p/139592932