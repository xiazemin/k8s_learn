 git submodule add https://github.com/iKubernetes/k8s-prom

prometheus目录：部署Promethues Metrics API Server所需要的各资源配置清单。
k8s-prometheus-adapter目录：部署基于prometheus的自定义指标API服务器所需要的各资源配置清单。
podinfo目录：测试使用的podinfo相关的deployment和service对象的资源配置清单。
node_exporter目录：于kubernetes集群各节点部署node_exporter。
kube-state-metrics：聚合kubernetes资源对象，提供指标数据。

https://github.com/stefanprodan/k8s-prom-hpa

% cd k8s-prom 
% kubectl apply -f namespace.yaml
namespace/prom created

% kubectl apply -f node_exporter/
daemonset.apps/prometheus-node-exporter created
service/prometheus-node-exporter created

 % kubectl get pods -n prom
NAME                             READY   STATUS    RESTARTS   AGE
prometheus-node-exporter-plsdj   0/1     Pending   0          33s

 % docker pull prom/node-exporter:v0.15.2
v0.15.2: Pulling from prom/node-exporter
Image docker.io/prom/node-exporter:v0.15.2 uses outdated schema1 manifest format. Please upgrade to a schema2 image for better future compatibility. More information at https://docs.docker.com/registry/spec/deprecated-schema-v1/
aa3e9481fcae: Pulling fs layer 
Digest: sha256:6965ed8f31c5edba19d269d10238f59624e6b004f650ce925b3408ce222f9e49
Status: Downloaded newer image for prom/node-exporter:v0.15.2
docker.io/prom/node-exporter:v0.15.2

https://registry.hub.docker.com/r/prom/node-exporter

 % kubectl delete cronJob alpine-cronjob
cronjob.batch "alpine-cronjob" deleted

 % kubectl get pod |grep alpine-cronjob |awk '{print $1}' |xargs kubectl delete pod


  /Applications/Docker.app/Contents/MacOS/com.docker.diagnose check
Starting diagnostics

https://docs.docker.com/desktop/mac/troubleshoot/#self-diagnose-tool



 % docker pull prom/prometheus:v2.2.1
Digest: sha256:129e16b08818a47259d972767fd834d84fb70ca11b423cc9976c9bce9b40c58f
Status: Downloaded newer image for prom/prometheus:v2.2.1
docker.io/prom/prometheus:v2.2.1


% kubectl apply -f prometheus/
configmap/prometheus-config created
deployment.apps/prometheus-server created
Warning: rbac.authorization.k8s.io/v1beta1 ClusterRole is deprecated in v1.17+, unavailable in v1.22+; use rbac.authorization.k8s.io/v1 ClusterRole
clusterrole.rbac.authorization.k8s.io/prometheus created
serviceaccount/prometheus created
Warning: rbac.authorization.k8s.io/v1beta1 ClusterRoleBinding is deprecated in v1.17+, unavailable in v1.22+; use rbac.authorization.k8s.io/v1 ClusterRoleBinding
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
service/prometheus created


% kubectl get all -n prom
NAME                                     READY   STATUS    RESTARTS   AGE
pod/prometheus-node-exporter-sk9c4       0/1     Pending   0          3m48s
pod/prometheus-server-59db489b4f-mqpsc   0/1     Pending   0          20s

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/prometheus                 NodePort    10.103.148.186   <none>        9090:30090/TCP   20s
service/prometheus-node-exporter   ClusterIP   None             <none>        9100/TCP         3m48s

NAME                                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
daemonset.apps/prometheus-node-exporter   1         1         0       1            0           <none>          3m48s

NAME                                READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/prometheus-server   0/1     1            0           20s

NAME                                           DESIRED   CURRENT   READY   AGE
replicaset.apps/prometheus-server-59db489b4f   1         1         0       20s


 % kubectl apply -f kube-state-metrics/
deployment.apps/kube-state-metrics created
serviceaccount/kube-state-metrics created
clusterrole.rbac.authorization.k8s.io/kube-state-metrics created
clusterrolebinding.rbac.authorization.k8s.io/kube-state-metrics created
service/kube-state-metrics created


 % docker pull gcr.io/google_containers/kube-state-metrics-amd64:v1.3.1
Error response from daemon: Get "https://gcr.io/v2/": context deadline exceeded


% docker pull kube-state-metrics-amd64:v1.3.1 
Error response from daemon: pull access denied for kube-state-metrics-amd64, repository does not exist or may require 'docker login': denied: requested access to the resource is denied


https://registry.hub.docker.com/r/bitnami/kube-state-metrics

 image: bitnami/kube-state-metrics gcr.io/google_containers/kube-state-metrics-amd64:v1.3.1

 % docker pull bitnami/kube-state-metrics
Using default tag: latest
latest: Pulling from bitnami/kube-state-metrics
Digest: sha256:bb3fce94f38ba2bce42d9dc2b6204f97139a48ffe2e335da3ccd4901986c5b55
Status: Downloaded newer image for bitnami/kube-state-metrics:latest
docker.io/bitnami/kube-state-metrics:latest

 % kubectl apply -f kube-state-metrics/ 


% kubectl get pods -n prom -o wide 
NAME                                  READY   STATUS    RESTARTS   AGE     IP       NODE     NOMINATED NODE   READINESS GATES
kube-state-metrics-7db98bf8ff-5p9m7   0/1     Pending   0          10s     <none>   <none>   <none>           <none>
prometheus-node-exporter-sk9c4        0/1     Pending   0          11m     <none>   <none>   <none>           <none>
prometheus-server-59db489b4f-mqpsc    0/1     Pending   0          7m32s   <none>   <none>   <none>           <none>
xiazemin@xiazemindeM





 % (umask 077; openssl genrsa -out serving.key 2048)
Generating RSA private key, 2048 bit long modulus (2 primes)
....................................................+++++
.......................+++++
e is 65537 (0x010001)

% openssl req -new -key serving.key -out serving.csr -subj "/CN=serving"

% openssl x509 -req -in serving.csr -CA ./ca.crt -CAkey ./ca.key -CAcreateserial -out serving.crt -days 3650
Signature ok
subject=CN = serving
Can't open ./ca.crt for reading, No such file or directory
4374396224:error:02001002:system library:fopen:No such file or directory:crypto/bio/bss_file.c:69:fopen('./ca.crt','r')
4374396224:error:2006D080:BIO routines:BIO_new_file:no such file:crypto/bio/bss_file.c:76:
unable to load certificate

%  kubectl create secret generic cm-adapter-serving-certs --from-file=serving.crt=./serving.crt --from-file=serving.key -n prom
error: error reading ./serving.crt: no such file or directory


% kubectl get secret -n prom
No resources found in prom namespace.

https://registry.hub.docker.com/r/ibmcom/k8s-prometheus-adapter-amd64
https://registry.hub.docker.com/r/directxman12/k8s-prometheus-adapter


 image: directxman12/k8s-prometheus-adapter-amd64 

 docker pull directxman12/k8s-prometheus-adapter:v0.8.4
v0.8.4: Pulling from directxman12/k8s-prometheus-adapter
a281075b7e6c: Pull complete 
d10489bdec1e: Pull complete 
Digest: sha256:b874cc7a126077cc062d698953450b8c459140dad53d65d6903c9f9489cb1afe
Status: Downloaded newer image for directxman12/k8s-prometheus-adapter:v0.8.4
docker.io/directxman12/k8s-prometheus-adapter:v0.8.4




% kubectl apply -f k8s-prometheus-adapter 
clusterrolebinding.rbac.authorization.k8s.io/custom-metrics:system:auth-delegator created
rolebinding.rbac.authorization.k8s.io/custom-metrics-auth-reader created
deployment.apps/custom-metrics-apiserver created
clusterrolebinding.rbac.authorization.k8s.io/custom-metrics-resource-reader created
serviceaccount/custom-metrics-apiserver created
service/custom-metrics-apiserver created
Warning: apiregistration.k8s.io/v1beta1 APIService is deprecated in v1.19+, unavailable in v1.22+; use apiregistration.k8s.io/v1 APIService
apiservice.apiregistration.k8s.io/v1beta1.custom.metrics.k8s.io created
clusterrole.rbac.authorization.k8s.io/custom-metrics-server-resources created
clusterrole.rbac.authorization.k8s.io/custom-metrics-resource-reader created
clusterrolebinding.rbac.authorization.k8s.io/hpa-controller-custom-metrics created

https://registry.hub.docker.com/r/rancher/heapster-grafana-amd64


https://registry.hub.docker.com/r/angelnu/heapster-grafana

docker pull angelnu/heapster-grafana:v5.0.4
v5.0.4: Pulling from angelnu/heapster-grafana
19e100455de7: Pull complete 
7d5f2ecd4c0f: Pull complete 
134d3b93b229: Pull complete 
7d67ef5adc05: Pull complete 
c953aa35e684: Pull complete 
Digest: sha256:3162c4b69ae75dd2f28c8e9d0fbf4f97216bcabdd68c9dac8dccaae5a043a124
Status: Downloaded newer image for angelnu/heapster-grafana:v5.0.4
docker.io/angelnu/heapster-grafana:v5.0.4


% kubectl apply -f grafana.yaml 
deployment.apps/monitoring-grafana created
service/monitoring-grafana created


https://www.cnblogs.com/linuxk/p/10582534.html