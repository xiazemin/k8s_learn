 (umask 077; openssl genrsa -out serving.key 2048)
 Generating RSA private key, 2048 bit long modulus (2 primes)
.........................................................+++++
..................+++++
e is 65537 (0x010001)

% ls
serving.key

%openssl req -new -key serving.key -out serving.csr -subj "/CN=serving"

% ls
serving.csr     serving.key


%openssl x509 -req -in serving.csr -CA ./ca.crt -CAkey ./ca.key -CAcreateserial -out serving.crt -days 3650


%openssl x509 -req -in  serving.csr -CA ~/Library/Group\ Containers/group.com.docker/pki/apiserver.crt  -CAkey ~/Library/Group\ Containers/group.com.docker/pki/apiserver.key -CAcreateserial -out serving.crt -days 3650

Signature ok
subject=CN = serving
Getting CA Private Key

 % ls
serving.crt     serving.csr     serving.key

%kubectl create secret generic cm-adapter-serving-certs --from-file=serving.crt=./serving.crt --from-file=serving.key -n prom

error: failed to create secret Post "https://kubernetes.docker.internal:6443/api/v1/namespaces/prom/secrets?fieldManager=kubectl-create": proxyconnect tcp: dial tcp 192.168.220.251:7890: i/o timeout

干掉 kubectl proxy


https://github.com/docker/for-mac/issues/3829


% vi ~/.kube/config


    server: https://kubernetes.docker.internal:6443
  name: docker-desktop

  server: https://127.0.0.1:6443


% kubectl create secret generic cm-adapter-serving-certs --from-file=serving.crt=./serving.crt --from-file=serving.key -n prom
secret/cm-adapter-serving-certs created


 % kubectl get secret -n prom
NAME                                   TYPE                                  DATA   AGE
cm-adapter-serving-certs               Opaque                                2      66s
custom-metrics-apiserver-token-j9mbv   kubernetes.io/service-account-token   3      28m
default-token-mkkgh                    kubernetes.io/service-account-token   3      28m
kube-state-metrics-token-hx796         kubernetes.io/service-account-token   3      28m
prometheus-token-6qv5d                 kubernetes.io/service-account-token   3      28m


 $kubectl apply -f k8s-prometheus-adapter 

 % kubectl get pods -n prom  
NAME                                        READY   STATUS    RESTARTS   AGE
custom-metrics-apiserver-696d8bc579-27gwv   0/1     Error     2          26s
kube-state-metrics-7db98bf8ff-5p9m7         1/1     Running   1          8h
monitoring-grafana-766d97bdb5-pcrph         1/1     Running   1          8h
prometheus-node-exporter-sk9c4              1/1     Running   1          9h
prometheus-server-59db489b4f-mqpsc          1/1     Running   1          9h


 % kubectl  -n prom describe pod custom-metrics-apiserver-696d8bc579-27gwv
Name:         custom-metrics-apiserver-696d8bc579-27gwv
Namespace:    prom
Priority:     0
Node:         docker-desktop/192.168.65.4
Start Time:   Wed, 22 Dec 2021 01:07:50 +0800
Labels:       app=custom-metrics-apiserver
              pod-template-hash=696d8bc579
Annotations:  <none>
Status:       Running
IP:           10.1.27.38
IPs:
  IP:           10.1.27.38
Controlled By:  ReplicaSet/custom-metrics-apiserver-696d8bc579
Containers:
  custom-metrics-apiserver:
    Container ID:  docker://96041a65b8f036a6e87b18324016829105adab70d0e8ed9d42fe5b2b8c8815f7
    Image:         directxman12/k8s-prometheus-adapter:v0.8.4
    Image ID:      docker-pullable://directxman12/k8s-prometheus-adapter@sha256:b874cc7a126077cc062d698953450b8c459140dad53d65d6903c9f9489cb1afe
    Port:          6443/TCP
    Host Port:     0/TCP
    Args:
      /adapter
      --secure-port=6443
      --tls-cert-file=/var/run/serving-cert/serving.crt
      --tls-private-key-file=/var/run/serving-cert/serving.key
      --logtostderr=true
      --prometheus-url=http://prometheus.prom.svc:9090/
      --metrics-relist-interval=30s
      --rate-interval=5m
      --v=10
    State:          Terminated
      Reason:       Error
      Exit Code:    2
      Started:      Wed, 22 Dec 2021 01:08:32 +0800
      Finished:     Wed, 22 Dec 2021 01:08:32 +0800
    Last State:     Terminated
      Reason:       Error
      Exit Code:    2
      Started:      Wed, 22 Dec 2021 01:08:05 +0800
      Finished:     Wed, 22 Dec 2021 01:08:05 +0800
    Ready:          False
    Restart Count:  3
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-9hcrw (ro)
      /var/run/serving-cert from volume-serving-cert (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             False 
  ContainersReady   False 
  PodScheduled      True 
Volumes:
  volume-serving-cert:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  cm-adapter-serving-certs
    Optional:    false
  kube-api-access-9hcrw:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason     Age                From               Message
  ----     ------     ----               ----               -------
  Normal   Scheduled  52s                default-scheduler  Successfully assigned prom/custom-metrics-apiserver-696d8bc579-27gwv to docker-desktop
  Normal   Pulled     10s (x4 over 52s)  kubelet            Container image "directxman12/k8s-prometheus-adapter:v0.8.4" already present on machine
  Normal   Created    10s (x4 over 52s)  kubelet            Created container custom-metrics-apiserver
  Normal   Started    10s (x4 over 51s)  kubelet            Started container custom-metrics-apiserver
  Warning  BackOff    10s (x5 over 50s)  kubelet            Back-off restarting failed container

 % kubectl -n prom logs custom-metrics-apiserver-696d8bc579-xkgzd 
unknown flag: --rate-interval
Usage of /adapter:
unknown flag: --rate-interval


% kubectl -n prom get svc monitoring-grafana
NAME                 TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
monitoring-grafana   NodePort   10.105.98.11   <none>        80:32649/TCP   8h


http://127.0.0.1:32649/?orgId=1


%  kubectl get svc -n  prom
NAME                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
custom-metrics-apiserver   ClusterIP   10.96.172.58     <none>        443/TCP          8h
kube-state-metrics         ClusterIP   10.109.86.171    <none>        8080/TCP         17h
monitoring-grafana         NodePort    10.105.98.11     <none>        80:32649/TCP     17h
prometheus                 NodePort    10.103.148.186   <none>        9090:30090/TCP   17h
prometheus-node-exporter   ClusterIP   None             <none>        9100/TCP         17h

http://127.0.0.1:30090/graph
kubelet_running_pods

