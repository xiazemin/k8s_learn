
https://docs.docker.com/desktop/mac/apple-silicon/

https://docs.docker.com/desktop/mac/troubleshoot/#self-diagnose-tool


 % /Applications/Docker.app/Contents/MacOS/com.docker.diagnose  checkStarting diagnostics

[PASS] DD0027: is there available disk space on the host?
[PASS] DD0028: is there available VM disk space?
[PASS] DD0031: does the Docker API work?
[PASS] DD0004: is the Docker engine running?
[PASS] DD0011: are the LinuxKit services running?
[FAIL] DD0016: is the LinuxKit VM running? vm is not running: vm has not started
[PASS] DD0001: is the application running?
[PASS] DD0018: does the host support virtualization?
[FAIL] DD0017: can a VM be started? vm has not started: vm has not started

 pred='process matches ".*(ocker|vpnkit).*" || (process in {"taskgated-helper", "launchservicesd", "kernel"} && eventMessage contains[c] "docker")'

/usr/bin/log stream --style syslog --level=debug --color=always --predicate "$pred"
Filtering the log data using "process MATCHES ".*(ocker|vpnkit).*" OR (process IN {"taskgated-helper", "launchservicesd", "kernel"} AND composedMessage CONTAINS[c] "docker")"


/usr/bin/log show --debug --info --style syslog --last 1d --predicate "$pred" >/tmp/logs.txt

cat  ~/Library/Containers/com.docker.docker/Data/log/vm/dockerd.log

~/Library/Containers/com.docker.docker/Data/log/vm/containerd.log

https://docs.docker.com/config/daemon/#read-the-logs

https://github.com/docker/for-mac/issues/6103

% nc -U ~/Library/Containers/com.docker.docker/Data/debug-shell.sock
/ # ^[[32;5R


https://docs.docker.com/desktop/mac/release-notes/edge-releases/


 % cd k8s-for-docker-desktop 

 % git checkout v1.22.4
Branch 'v1.22.4' set up to track remote branch 'v1.22.4' from 'origin'.
Switched to a new branch 'v1.22.4'

 % git pull


 % sh load_images.sh 


 https://docs.docker.com/desktop/mac/release-notes/

 Upgrades
Docker Engine v20.10.11
containerd v1.4.12
Buildx 0.7.1
Compose v2.2.1
Kubernetes 1.22.4
Docker Hub Tool v0.4.4
Go 1.17.3

Deprecation
The following internal DNS names are deprecated and will be removed from a future release: docker-for-desktop, docker-desktop, docker.for.mac.host.internal, docker.for.mac.localhost, docker.for.mac.gateway.internal. You must now use host.docker.internal, vm.docker.internal, and gateway.docker.internal.
Custom RBAC rules have been removed from Docker Desktop as it gives cluster-admin privileges to all Service Accounts. Fixes docker/for-mac/#4774.

重新下载docker 替换



 % kubectl delete  ns local --force
warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.
namespace "local" force deleted

 % kubectl get ns local -o json > tmp.json

 删除spec及status部分的内容，剩下内容如下

  % kubectl get ns local -o yaml >> local.ns.yaml

   % kubectl delete -f local.ns.yaml
namespace "local" deleted

 % kubectl delete ValidatingWebhookConfiguration admission-webhook-example
validatingwebhookconfiguration.admissionregistration.k8s.io "admission-webhook-example" deleted


curl -k -H "Content-Type: application/json" -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/local/finalize


https://blog.csdn.net/shengjie87/article/details/108976085



重启：成功了

% kubectl get all -n prom
NAME                                            READY   STATUS              RESTARTS   AGE
pod/custom-metrics-apiserver-696d8bc579-qhbrv   0/1     ContainerCreating   0          8h
pod/kube-state-metrics-7db98bf8ff-5p9m7         1/1     Running             1          8h
pod/monitoring-grafana-766d97bdb5-pcrph         1/1     Running             1          8h
pod/prometheus-node-exporter-sk9c4              1/1     Running             1          8h
pod/prometheus-server-59db489b4f-mqpsc          1/1     Running             1          8h

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/custom-metrics-apiserver   ClusterIP   10.101.177.197   <none>        443/TCP          8h
service/kube-state-metrics         ClusterIP   10.109.86.171    <none>        8080/TCP         8h
service/monitoring-grafana         NodePort    10.105.98.11     <none>        80:32649/TCP     8h
service/prometheus                 NodePort    10.103.148.186   <none>        9090:30090/TCP   8h
service/prometheus-node-exporter   ClusterIP   None             <none>        9100/TCP         8h

NAME                                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
daemonset.apps/prometheus-node-exporter   1         1         1       1            1           <none>          8h

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/custom-metrics-apiserver   0/1     1            0           8h
deployment.apps/kube-state-metrics         1/1     1            1           8h
deployment.apps/monitoring-grafana         1/1     1            1           8h
deployment.apps/prometheus-server          1/1     1            1           8h

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/custom-metrics-apiserver-696d8bc579   1         1         0       8h
replicaset.apps/kube-state-metrics-7db98bf8ff         1         1         1       8h
replicaset.apps/monitoring-grafana-766d97bdb5         1         1         1       8h
replicaset.apps/prometheus-server-59db489b4f          1         1         1       8h



 % kubectl -n prom get pod -o wide
NAME                                        READY   STATUS              RESTARTS   AGE   IP             NODE             NOMINATED NODE   READINESS GATES
custom-metrics-apiserver-696d8bc579-qhbrv   0/1     ContainerCreating   0          8h    <none>         docker-desktop   <none>           <none>
kube-state-metrics-7db98bf8ff-5p9m7         1/1     Running             1          8h    10.1.27.15     docker-desktop   <none>           <none>
monitoring-grafana-766d97bdb5-pcrph         1/1     Running             1          8h    10.1.27.18     docker-desktop   <none>           <none>
prometheus-node-exporter-sk9c4              1/1     Running             1          8h    192.168.65.4   docker-desktop   <none>           <none>
prometheus-server-59db489b4f-mqpsc          1/1     Running             1          8h    10.1.27.17     docker-desktop   <none>           <none>




 % kubectl -n prom describe pod custom-metrics-apiserver-696d8bc579-qhbrv
Name:           custom-metrics-apiserver-696d8bc579-qhbrv
Namespace:      prom
Priority:       0
Node:           docker-desktop/192.168.65.4
Start Time:     Wed, 22 Dec 2021 00:37:00 +0800
Labels:         app=custom-metrics-apiserver
                pod-template-hash=696d8bc579
Annotations:    <none>
Status:         Pending
IP:
IPs:            <none>
Controlled By:  ReplicaSet/custom-metrics-apiserver-696d8bc579
Containers:
  custom-metrics-apiserver:
    Container ID:
    Image:         directxman12/k8s-prometheus-adapter:v0.8.4
    Image ID:
    Port:          6443/TCP
    Host Port:     0/TCP
    Args:
      /adapter
      --secure-port=6443
      --tls-cert-file=/var/run/serving-cert/serving.crt
      --tls-private-key-file=/var/run/serving-cert/serving.key
      --logtostderr=true
      --prometheus-url=http://prometheus.prom.svc:9090/
      --metrics-relist-interval=30s
      --rate-interval=5m
      --v=10
    State:          Waiting
      Reason:       ContainerCreating
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-4z6ss (ro)
      /var/run/serving-cert from volume-serving-cert (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  volume-serving-cert:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  cm-adapter-serving-certs
    Optional:    false
  kube-api-access-4z6ss:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason       Age                    From               Message
  ----     ------       ----                   ----               -------
  Normal   Scheduled    9m59s                  default-scheduler  Successfully assigned prom/custom-metrics-apiserver-696d8bc579-qhbrv to docker-desktop
  Warning  FailedMount  8m56s (x8 over 9m59s)  kubelet            MountVolume.SetUp failed for volume "volume-serving-cert" : secret "cm-adapter-serving-certs" not found
  Warning  FailedMount  3m55s                  kubelet            Unable to attach or mount volumes: unmounted volumes=[volume-serving-cert], unattached volumes=[kube-api-access-4z6ss volume-serving-cert]: timed out waiting for the condition
  Warning  FailedMount  2m1s (x11 over 8m13s)  kubelet            MountVolume.SetUp failed for volume "volume-serving-cert" : secret "cm-adapter-serving-certs" not found
  Warning  FailedMount  97s (x2 over 6m12s)    kubelet            Unable to attach or mount volumes: unmounted volumes=[volume-serving-cert], unattached volumes=[volume-serving-cert kube-api-access-4z6ss]: timed out waiting for the condition

  