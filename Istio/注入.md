 Envoy 被部署为 sidecar，和对应服务在同一个 Kubernetes pod 中。这允许 Istio 将大量关于流量行为的信号作为属性提取出来，而这些属性又可以在 Mixer 中用于执行策略决策，并发送给监控系统，以提供整个网格行为的信息。
Sidecar 代理模型还可以将 Istio 的功能添加到现有部署中，而无需重新构建或重写代码。

 1.1 手动注入
   istioctl命令更改配置文件
$ istioctl  kube-inject  -f  <your-app>.yaml -o <your-app-addEnvoy>.yaml

    部署应用
$ kubectl create -f <your-app-addEnvoy>.yaml


注入后的文件
Annotation： 标注了这一部署和pod是否已经被注入，被什么版本注入

proxy container ：容器是envoy代理容器。容器两个进程，父进程为守护进程传入启动参数给子进程。子进程proxy负责转发流量

InitContainer: 容器初始化，对iptables做一些配置。使其跳过和proxy进程用户一致的用户进程的流量处理，跳过Loopback流量处理，其余所有流量转发到15001端口
Envoy 实现了过滤和路由，并在pilot,mixer协助下服务发现、健康检查，提供了具有弹性的负载均衡。




      Mixer 是一个独立于平台的组件，负责在服务网格上执行访问控制和使用策略，并从 Envoy 代理和其他服务收集遥测数据。代理提取请求级属性，发送到 Mixer 进行评估
       Mixer 中包括一个灵活的插件模型，使其能够接入到各种主机环境和基础设施后端，从这些细节中抽象出 Envoy 代理和 Istio 管理的服务。


控制面中负责流量管理的组件为Pilot

        Pilot 为 Envoy sidecar 提供服务发现功能，为智能路由（例如 A/B 测试、金丝雀部署等）和弹性（超时、重试、熔断器等）提供流量管理功能。它将控制流量行为的高级路由规则转换为特定于 Envoy 的配置，并在运行时将它们传播到 sidecar。

        Pilot 将平台特定的服务发现机制抽象化并将其合成为符合 Envoy 数据平面 API 的任何 sidecar 都可以使用的标准格式。这种松散耦合使得 Istio 能够在多种环境下运行（例如，Kubernetes、Consul、Nomad），同时保持用于流量管理的相同操作界面。


Platform Adapter: 平台适配器。针对多种集群管理平台实现的控制器，得到API server的DNS服务注册信息（即service名与podIP的对应表）、入口资源以及存储流量管理规则的第三方资源
Abstract Model：维护了envoy中对service的规范表示。接收上层获取的service信息转化为规范模型
Envoy API：下发服务发现、流量规则到envoy上
Rules API：由运维人员管理。可通过API配置高级管理规则


 Citadel 通过内置身份和凭证管理可以提供强大的服务间和最终用户身份验证。可用于升级服务网格中未加密的流量，并为运维人员提供基于服务标识而不是网络控制的强制执行策略的能力。


 https://blog.csdn.net/zhonglinzhang/article/details/85233390




 Envoy在网络控制方面的主要功能如下。

HTTP 7层路由。
支持gRPC、HTTP/2。
服务发现和动态配置。
健康检查。
高级负载均衡。
在Kubernetes环境中，同一个Pod内的不同容器间共享网络栈，这一特性使得Sidecar可以接管进出这些容器的网络流量，这就是Sidecar模式的实现基础。Envoy是目前Istio默认的数据平面，实际上因为Istio灵活的架构，完全可以选择其他兼容的产品作为Sidecar。目前很多服务网格产品都可以作为Istio的数据平面并提供集成。


Pilot 是Istio实现流量管理的核心组件，它主要的作用是配置和管理Envoy代理。比如可以为代理之间设置特定的流量规则，或者配置超时、重试、熔断这样的弹性能力。Pilot会将控制流量行为的路由规则转换为Envoy的配置，并在运行时将它们广播到Envoy。另外，Pilot还能够把服务发现机制抽象出来并转换成API分发给Envoy，使得后者具有服务发现的能力。

简单来说，Pilot的主要任务有两个。

从平台（如Kubernetes）获取服务信息，完成服务发现。
获取Istio的各项配置，转换成Envoy代理可读的格式并分发。


在2019年3月份发布的1.1版本中，Galley作为一个独立的组件被添加到了架构当中（在此之前的版本中Galley并未独立出现），它现在是Istio主要的配置管理组件，负责配置的获取、处理和分发。Galley使用了一种叫作MCP（Mesh Configuration Protocol，网格配置协议）的协议与其他组件进行通信。




Istio为了控制服务请求，引入了服务版本（Version）的概念，可以通过版本这一标签将服务进行区分。版本的设置是非常灵活的，可以根据服务的迭代编号进行定义（如v1、v2版本）；也可以根据部署环境进行定义（如Dev、Staging和Production）；或者是自定义任何用于区分服务的标记。通过版本标签，Istio就可以定义灵活的路由规则以控制流量，上面提到的金丝雀发布这类应用场景就很容易实现了。

Pilot组件会从平台获取服务的注册信息，并提供服务发现的接口，Envoy获得这些信息并更新到自己的负载均衡池。Envoy会定期地对池中的实例进行健康检查，剔除离线的实例，保证服务信息的实时性。

https://zhuanlan.zhihu.com/p/81546576



Proxy 就是服务代理用的Envoy


Gateway :服务网关转发到VitualService主要是根据我们的请求

，一个服务有三个版本v1v2v3根据条件转发到哪个版本，

VitualService把请求导入到某个v1版本之后这会就走到

DestinationRule主要工作是假设v1有三个副本负载均衡策略使用和最小连接的配置


DestinationRule 是在VirtualService导入指定服务的版本之后，进行一个实例副本数的负载，限流策略等。 trafficPolicy 是定义默认策略 LEAST_CONN 是最小连接，subsets 是指定哪些版本使用这个链接策略。


VirtualService里面绑定了Gateway,建立绑定关系,ServiceEntry 如果想访问外网也是需要建立这个东西

https://blog.csdn.net/weixin_37546425/article/details/104326101


https://www.cnblogs.com/JoZSM/p/10902306.html
https://www.cnblogs.com/skabyy/p/10668079.html


xDS是一类发现服务的总称，包含LDS， RDS， CDS， EDS以及SDS。
Envoy通过xDS API可以动态获取Listener（监听器），Route（路由）， Cluster（集群）， Endpoint（集群成员）以及Secret（证书）配置。


Listener 发现服务。

Listener监听器控制Envoy启动端口监听（目前只支持TCP协议），并配置L3/L4层过滤器，当网络连接达到后，配置好的网络过滤器堆栈开始处理后续事件。

这种通用的监听器体系结构用于执行大多数不同的代理任务（限流，客户端认证， HTTP连接管理， TCP代理等）。


LDS
Listener 发现服务。

Listener监听器控制Envoy启动端口监听（目前只支持TCP协议），并配置L3/L4层过滤器，当网络连接达到后，配置好的网络过滤器堆栈开始处理后续事件。

这种通用的监听器体系结构用于执行大多数不同的代理任务（限流，客户端认证， HTTP连接管理， TCP代理等）。

RDS
Route发现服务，用于HTTP连接管理过滤器动态获取路由配置。

路由配置包含HTTP头部修改（增加、删除HTTP头部键值），virtual hosts （虚拟主机），以及virtual hosts 定义的各个路由条目。

CDS
Cluster发现服务，用于动态获取Cluster信息。

Envoy cluster管理器管理着所有的上游cluster。

鉴于上游cluster或者主机可用于任何代理转发任务，所以上游cluster一般从Listener或Route中抽象出来。

EDS
Endpoint发现服务。

在Envoy术语中， Cluster成员就叫 Endpoint，对于每个Cluster， Envoy通过EDS API动态获取Endpoint。

EDS作为首选的服务发现的原因有两点：

与通过DNS解析的负载均衡器进行路由相比， Envoy能明确的知道每个上游主机的信息，因而可以做出更加智能的负载均衡决策。
Endpoint配置包含负载均衡权重、可用域等附加主机属性，这些属性可用域服务网格负载均衡，统计收集等过程中。
 
SDS
Secret发现服务，用于运行时动态获取TLS证书。

若没有SDS特性，在k8s环境中，必须创建包含证书的Secret，代理启动前Secret必须挂载到sidecar容器中，如果证书过期，则需要重新部署。

使用SDS，集中式的SDS 服务器将证书分发给所有的Envoy实例，如果证书过期，服务器会将新的证书分发， Envoy
接收到新的证书后重新加载儿不用重新部署


https://blog.csdn.net/fly910905/article/details/104036296

https://blog.csdn.net/weixin_37546425/article/details/104496074
http://www.voycn.com/article/istioxdsxieyijiexi

https://blog.csdn.net/weixin_34009794/article/details/91458362


v1alpha3引入了以下这些新的配置资源来控制进入网格，网格内部和离开网格的流量路由。

Gateway：gateway资源可以将网格内部的服务暴露给网格外部的服务，供网格外部的服务调用，该资源描述了需要公开的端口、端口的协议类型、以及域名等。
VirtualService：virtualService用来与Gateway绑定，实现服务访问路由控制、服务版本与流量的控制。
DestinationRule：外部请求经过VirtualService的路由规则后，如果目标服务设置了dr，那么dr配置的目标服务策略会生效。
ServiceEntry：将网格外的服务加到服务发现中，就像是网格内的服务一样被治理（成为k8s中的一个service），如网格外的mysql、redis等服务，或是部署在物理机上未加入网格内部的服务。将ServiceEntry描述的service加到服务发现中，对这些服务的outbound流量进行拦截，从而进行治理。
当ServiceEntry描述的service有endpoint变化时，我们可以监听其变化，利用k8s基建，创建或者删除k8s该service的endpoint，由于istio的服务发现依赖于k8s，该变化会被istio pilot-discovery感知到，并通过xDs通知envoy。
VirtualService，DestinationRule和ServiceEntry分别替换了原API中的RouteRule，DestinationPolicy和EgressRule。 Gateway是一个独立于平台的抽象，用于对流入专用中间设备的流量进行建模


https://www.cnblogs.com/fat-girl-spring/p/15162134.html



