% kubectl -n istio-system describe pod istiod-6fb996b56-s69k7
 Warning  FailedScheduling  46s   default-scheduler  0/1 nodes are available: 1 Insufficient cpu.

cpu: 500m     =>     cpu: 1000m

  Warning  FailedScheduling  17s   default-scheduler  0/1 nodes are available: 1 Insufficient cpu.

docker for mac 4核 =》 6核


%  kubectl -n istio-system get pod                            
NAME                                    READY   STATUS    RESTARTS   AGE
istio-egressgateway-6ff67579c4-87g4v    1/1     Running   1          10m
istio-ingressgateway-67b86984bb-c9kzl   1/1     Running   1          10m
istiod-6fb996b56-4fnxb                  0/1     Pending   0          73s
istiod-6fb996b56-brght                  1/1     Running   0          73s
istiod-6fb996b56-xgz9h                  0/1     Pending   0          73s

%  kubectl -n istio-system describe pod istiod-6fb996b56-4fnxb
  Warning  FailedScheduling  86s (x2 over 88s)  default-scheduler  0/1 nodes are available: 1 Insufficient memory.

docker for mac 8G =》 12G

 %  kubectl -n istio-system get pod                              
NAME                                    READY   STATUS    RESTARTS   AGE
istio-egressgateway-6ff67579c4-87g4v    0/1     Running   2          14m
istio-ingressgateway-67b86984bb-c9kzl   0/1     Running   2          14m
istiod-565dcf968b-fd872                 1/1     Running   0          3m9s
istiod-565dcf968b-ffwv4                 1/1     Running   0          3m9s
istiod-565dcf968b-qkv8k                 1/1     Running   1          3m9s


 % kubectl delete -f istio-egressgateway.yaml 
deployment.apps "istio-egressgateway" deleted
% kubectl delete -f istio-ingressgateway.yaml
deployment.apps "istio-ingressgateway" deleted
% kubectl apply -f istio-ingressgateway.yaml
deployment.apps/istio-ingressgateway created
 % kubectl apply -f istio-egressgateway.yaml 
deployment.apps/istio-egressgateway created


 %  kubectl -n istio-system get pod           
NAME                                    READY   STATUS    RESTARTS   AGE
istio-egressgateway-6ff67579c4-l6668    1/1     Running   0          9s
istio-ingressgateway-67b86984bb-w8wcg   1/1     Running   0          28s
istiod-565dcf968b-fd872                 1/1     Running   0          4m30s
istiod-565dcf968b-ffwv4                 1/1     Running   0          4m30s
istiod-565dcf968b-qkv8k                 1/1     Running   1          4m30s



 % kubectl describe pod details-v1-79f774bdb9-szlln  
   Normal   Scheduled  49s               default-scheduler  Successfully assigned default/details-v1-79f774bdb9-szlln to docker-desktop
  Normal   Pulled     4s (x4 over 47s)  kubelet            Container image "docker.io/istio/proxyv2:1.12.0" already present on machine
  Normal   Created    4s (x4 over 47s)  kubelet            Created container istio-init
  Normal   Started    4s (x4 over 47s)  kubelet            Started container istio-init
  Warning  BackOff    2s (x5 over 42s)  kubelet            Back-off restarting failed container


  镜像都是amd的
  https://hub.docker.com/r/istio/examples-bookinfo-reviews-v1/tags?page=1


  删除镜像本地编译
% docker images |grep istio/examples |awk '{print $1":"$2}'
istio/examples-bookinfo-reviews-v3:1.16.2
istio/examples-bookinfo-reviews-v2:1.16.2
istio/examples-bookinfo-reviews-v1:1.16.2
istio/examples-bookinfo-ratings-v1:1.16.2
istio/examples-bookinfo-details-v1:1.16.2
istio/examples-bookinfo-productpage-v1:1.16.2
% docker images |grep istio/examples |awk '{print $1":"$2}' |xargs docker rmi


https://github.com/istio/istio/tree/master/samples/bookinfo

 % cd samples/bookinfo
%  src/build-services.sh 1.16.2 docker.io/istio
~/source/k8s_learn/Istio/istio-1.12.1/samples/bookinfo/src/productpage ~/source/k8s_learn/Istio/istio-1.12.1/samples/bookinfo
[+] Building 0.1s (1/2)                                                                                                                                     
 => [internal] load build definition from Dockerfile                                                                                                   0.0s
 => => transferring dockerfile: 2B                                                                                                                     0.0s
failed to solve with frontend dockerfile.v0: failed to read dockerfile: open /var/lib/docker/tmp/buildkit-mount762404850/Dockerfile: no such file or directory

 % git submodule add https://github.com/istio/istio
Cloning into '/Users/xiazemin/source/k8s_learn/Istio/istio'...


 cd samples/bookinfo
 src/build-services.sh 1.16.2 docker.io/istio



 Istio/istio/samples/bookinfo/src/productpage/Dockerfile

 FROM python:3.7.7-slim =》 FROM python:3.7.7-alpine
https://hub.docker.com/_/python?tab=tags&page=1&name=3.7.7



% docker pull python:3.7.7-alpine
3.7.7-alpine: Pulling from library/python
3.7.7-alpine: Pulling from library/python
b538f80385f9: Pull complete 
0d489d24c263: Pull complete 
d7456013ab58: Pull complete 
2b7af659da21: Pull complete 
5846b63f0916: Pull complete 
Digest: sha256:4bc145d0bfababffd78b6106abd41000aa5dcc28cd0cfe5f988a415d1985667f
Status: Downloaded newer image for python:3.7.7-alpine
docker.io/library/python:3.7.7-alpine


% src/build-services.sh 1.16.2 docker.io/istio
~/source/k8s_learn/Istio/istio/samples/bookinfo/src/productpage ~/source/k8s_learn/Istio/istio/samples/bookinfo
[+] Building 13.7s (3/4)                                                                                                            
 => [internal] load build definition from Dockerfile 


=> ERROR [ 3/13] RUN pip install --no-cache-dir -r requirements.txt                                                         160.0s
------                                                                                                                              
 > [ 3/13] RUN pip install --no-cache-dir -r requirements.txt:     

 #8 153.3   ERROR: Command errored out with exit status 1:
#8 153.3    command: /usr/local/bin/python -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/tmp/pip-install-o84wqmyg/greenlet/setup.py'"'"'; __file__='"'"'/tmp/pip-install-o84wqmyg/greenlet/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' bdist_wheel -d /tmp/pip-wheel-0y689k_6

#8 158.3     gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -DTHREAD_STACK_SIZE=0x100000 -fPIC -I/usr/local/include/python3.7m -c greenlet.c -o build/temp.linux-aarch64-3.7/greenlet.o
#8 158.3     unable to execute 'gcc': No such file or directory
#8 158.3     error: command 'gcc' failed with exit status 1
#8 158.3     ----------------------------------------
#8 158.3 ERROR: Command errored out with exit status 1: /usr/local/bin/python -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/tmp/pip-install-o84wqmyg/greenlet/setup.py'"'"'; __file__='"'"'/tmp/pip-install-o84wqmyg/greenlet/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' install --record /tmp/pip-record-ud2jufue/install-record.txt --single-version-externally-managed --compile --install-headers /usr/local/include/python3.7m/greenlet Check the logs for full command output.
#8 159.1 WARNING: You are using pip version 20.1.1; however, version 21.3.1 is available.
#8 159.1 You should consider upgrading via the '/usr/local/bin/python -m pip install --upgrade pip' command.
------

docker pull python:latest
https://hub.docker.com/_/python?tab=tags


Istio/istio/samples/bookinfo/src/productpage/Dockerfile
FROM python:3.7.7-alpine  

% docker tag python:latest python:arm64

% src/build-services.sh 1.16.2 docker.io/istio
 => ERROR [internal] load metadata for docker.io/library/python:arm64                                                        101.4s
 => [auth] library/python:pull token for registry.cn-beijing.aliyuncs.com   
failed to solve with frontend dockerfile.v0: failed to create LLB definition: pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed


https://github.com/docker/buildx/issues/476
docker logout

https://blog.csdn.net/qq_39559641/article/details/121169045


https://hub.docker.com/layers/python/library/python/latest/images/sha256-d1500c47f0bbf08f47ab4d297468e7831747f574b85f9f6dd673e63ff0a9b401?context=explore


https://hub.docker.com/_/python?tab=tags&page=1
docker pull python:latest

FROM docker.io/library/python:latest


docker build [OPTIONS] PATH | URL | -
OPTIONS说明：

--build-arg=[] :设置镜像创建时的变量；

--cpu-shares :设置 cpu 使用权重；

--cpu-period :限制 CPU CFS周期；

--cpu-quota :限制 CPU CFS配额；

--cpuset-cpus :指定使用的CPU id；

--cpuset-mems :指定使用的内存 id；

--disable-content-trust :忽略校验，默认开启；

-f :指定要使用的Dockerfile路径；

--force-rm :设置镜像过程中删除中间容器；

--isolation :使用容器隔离技术；

--label=[] :设置镜像使用的元数据；

-m :设置内存最大值；

--memory-swap :设置Swap的最大值为内存+swap，"-1"表示不限swap；

--no-cache :创建镜像的过程不使用缓存；

--pull :尝试去更新镜像的新版本；

--quiet, -q :安静模式，成功后只输出镜像 ID；

--rm :设置镜像成功后删除中间容器；

--shm-size :设置/dev/shm的大小，默认值是64M；

--ulimit :Ulimit配置。

--squash :将 Dockerfile 中所有的操作压缩为一层。

--tag, -t: 镜像的名字及标签，通常 name:tag 或者 name 格式；可以在一次构建中为一个镜像设置多个标签。

--network: 默认 default。在构建期间设置RUN指令的网络模式



Istio/istio/samples/bookinfo/src/build-services.sh
docker build --pull  =》 docker build 


#11 91.89 ERROR: Cannot install -r requirements.txt (line 22) and urllib3==1.26.5 because these package versions have conflicting dependencies.


docker pull python:3.7.7-stretch
Status: Downloaded newer image for python:3.7.7-stretch
docker.io/library/python:3.7.7-stretch

pushd 目录
 
pushd后面如果直接跟目录使用，会切换到该目录并且将该目录置于目录栈的栈顶。(时时刻刻都要记住，目录栈的栈顶永远存放的是当前目录。如果当前目录发生变化，那么目录栈的栈顶元素肯定也变了；反过来，如果栈顶元素发生变化，那么当前目录肯定也变了。)下面是一个例子：
 

https://www.cnblogs.com/suanec/p/8026964.html



FROM docker.io/library/python:3.7.7-stretch
 % src/build-services.sh 1.16.2 docker.io/istio
~/source/k8s_learn/Istio/istio/samples/bookinfo/src/productpage ~/source/k8s_learn/Istio/istio/samples/bookinfo
[+] Building 16.8s (6/16)                 
 => ERROR [internal] load metadata for docker.io/library/ruby:2.7.1-slim  


docker pull ruby:2.7.1-slim-buster
https://hub.docker.com/_/ruby?tab=tags&page=1&name=2.7.1
Status: Downloaded newer image for ruby:2.7.1-slim-buster
docker.io/library/ruby:2.7.1-slim-buster

Istio/istio/samples/bookinfo/src/details/Dockerfile

From ruby:2.7.1-slim  From docker.io/library/ruby:2.7.1-slim-buster


Unable to find image 'gradle:4.8.1' locally

docker pull gradle:4.8.1
https://hub.docker.com/_/gradle?tab=tags&page=1&name=4.8.1


 => ERROR [internal] load metadata for docker.io/library/websphere-liberty:20.0.0.6-full-java8-ibmjava  
https://hub.docker.com/search?q=websphere-liberty&type=image&architecture=arm64
docker pull odidev/websphere-liberty:21.0.0.3-full-java11-openj9
Digest: sha256:990c9dcf6efd5c585818d5a9f0b536cc7c03ea17af2b0e3b24d2c540cdfe59bd
Status: Downloaded newer image for odidev/websphere-liberty:21.0.0.3-full-java11-openj9
docker.io/odidev/websphere-liberty:21.0.0.3-full-java11-openj9

Istio/istio/samples/bookinfo/src/reviews/reviews-wlpcfg/Dockerfile
FROM websphere-liberty:20.0.0.6-full-java8-ibmjava
FROM odidev/websphere-liberty:21.0.0.3-full-java11-openj9


=> ERROR [internal] load metadata for docker.io/library/node:12.18.1-slim  

https://hub.docker.com/_/node?tab=tags&page=1&name=12.18.1
 % docker pull node:12.18.1-slim
12.18.1-slim: Pulling from library/node
Digest: sha256:0158aaaa87e76a3d05181a6f1dfeee437afc773771f9a3bb86400a2d3dd164c4
Status: Downloaded newer image for node:12.18.1-slim
docker.io/library/node:12.18.1-slim


=> ERROR [internal] load metadata for docker.io/library/mysql:8.0.20 

https://hub.docker.com/_/mariadb?tab=tags
 % docker pull mariadb:10.7.1-focal
Digest: sha256:832c6e488f49720f484f87ee9f2cd4487321b373db07ac77037860bcd97d92bb
Status: Downloaded newer image for mariadb:10.7.1-focal
docker.io/library/mariadb:10.7.1-focal

Istio/istio/samples/bookinfo/src/mysql/Dockerfile
FROM mysql:8.0.20 FROM mariadb:10.7.1-focal


https://hub.docker.com/_/mongo?tab=tags&page=1&name=4.0.19
docker pull mongo:4.0.19-xenial



 % docker images |grep examples-bookinfo
istio/examples-bookinfo-mongodb                                   1.16.2                                                      93ee8f8573e8   31 seconds ago   395MB
istio/examples-bookinfo-mongodb                                   latest                                                      93ee8f8573e8   31 seconds ago   395MB
istio/examples-bookinfo-mysqldb                                   1.16.2                                                      31b1f5f7a9eb   14 minutes ago   395MB
istio/examples-bookinfo-mysqldb                                   latest                                                      31b1f5f7a9eb   14 minutes ago   395MB
istio/examples-bookinfo-reviews-v2                                1.16.2                                                      2425d5688ad0   14 minutes ago   541MB
istio/examples-bookinfo-reviews-v2                                latest                                                      2425d5688ad0   14 minutes ago   541MB
istio/examples-bookinfo-reviews-v3                                1.16.2                                                      4b98d3631927   14 minutes ago   541MB
istio/examples-bookinfo-reviews-v3                                latest                                                      4b98d3631927   14 minutes ago   541MB
istio/examples-bookinfo-reviews-v1                                1.16.2                                                      b2ccb345e027   14 minutes ago   541MB
istio/examples-bookinfo-reviews-v1                                latest                                                      b2ccb345e027   14 minutes ago   541MB
istio/examples-bookinfo-ratings-v2                                1.16.2                                                      6ef98de48549   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v2                                latest                                                      6ef98de48549   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v-unavailable                     1.16.2                                                      4584a300010a   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v-unavailable                     latest                                                      4584a300010a   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v-delayed                         1.16.2                                                      6eab9d3aeba7   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v-delayed                         latest                                                      6eab9d3aeba7   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v-faulty                          1.16.2                                                      11eb44e08049   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v-faulty                          latest                                                      11eb44e08049   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v-unhealthy                       1.16.2                                                      e2ebaea6ffe8   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v-unhealthy                       latest                                                      e2ebaea6ffe8   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v1                                1.16.2                                                      880a5ca8d5b3   19 minutes ago   154MB
istio/examples-bookinfo-ratings-v1                                latest                                                      880a5ca8d5b3   19 minutes ago   154MB
istio/examples-bookinfo-details-v1                                1.16.2                                                      6a100c4cf79a   47 minutes ago   139MB
istio/examples-bookinfo-details-v1                                latest                                                      6a100c4cf79a   47 minutes ago   139MB
istio/examples-bookinfo-details-v2                                1.16.2                                                      00d1b0856c0b   47 minutes ago   139MB
istio/examples-bookinfo-details-v2                                latest                                                      00d1b0856c0b   47 minutes ago   139MB
istio/examples-bookinfo-productpage-v-flooding                    1.16.2                                                      9f7ca0ec11b4   53 minutes ago   937MB
istio/examples-bookinfo-productpage-v-flooding                    latest                                                      9f7ca0ec11b4   53 minutes ago   937MB
istio/examples-bookinfo-productpage-v1                            1.16.2                                                      9d82bfca969f   53 minutes ago   937MB
istio/examples-bookinfo-productpage-v1                            latest                                                      9d82bfca969f   53 minutes ago   937MB

% sh restart.sh 



% kubectl describe pod details-v1-79f774bdb9-8m9h9
Readiness:  http-get http://:15021/healthz/ready delay=1s timeout=3s period=2s #success=1 #failure=30

Istio/istio-ingressgateway.yaml
Istio/istio-egressgateway.yaml
        prometheus.io/port: "15020"  =》         prometheus.io/port: "15021"



https://github.com/istio/istio/issues/18242

 % kubectl get cm istio-sidecar-injector -n istio-system -o yaml | sed -e 's/"rewriteAppHTTPProbe":false/"rewriteAppHTTPProbe":true/' | kubectl apply -f -

configmap/istio-sidecar-injector configured

%  kubectl apply -f <(istioctl kube-inject -f ../istio/samples/health-check/liveness-http-same-port.yaml)
service/liveness-http created
deployment.apps/liveness-http created



sidecar注入是依赖k8s的webhook功能来实现的，在创建pod的Crd资源增加了istio的配置


多了2个东西的配置

istio-init
istio-proxy
istio-init
init容器 给pod配置iptables 让流量进入pod和出pod都重定向sidecar指定端口

用的镜像：docker.io/istio/proxyv2:1.12.1

新版本的istio已经用go语言重写了，以前老版本是一个sh脚本来配置iptables的

看老本也许更容易明白 https://github.com/istio/istio/blob/0.5.0/tools/deb/istio-iptables.sh

https://github.com/istio/istio/blob/0.5.0/tools/deb/istio-iptables.sh


stio的sidecar注入，把pod的流量的出入用iptables的方式拦截了到了Envoy,
https://www.cnblogs.com/yudongdong/p/15734438.html