/ # route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         localhost       0.0.0.0         UG    202    0        0 eth0
10.1.0.0        *               255.255.0.0     U     0      0        0 cni0
127.0.0.0       *               255.0.0.0       U     0      0        0 lo
172.17.0.0      *               255.255.0.0     U     0      0        0 docker0
172.18.0.0      *               255.255.0.0     U     0      0        0 br-421a9e16d12b
192.168.65.0    *               255.255.255.0   U     202    0        0 eth0
192.168.65.5    *               255.255.255.255 UH    0      0        0 services1

https://www.netfilter.org/

wget https://www.netfilter.org/projects/iptables/files/iptables-1.8.2.tar.bz
2

/ # ping docker.for.mac.host.internal
PING docker.for.mac.host.internal (192.168.65.2): 56 data bytes
64 bytes from 192.168.65.2: seq=0 ttl=38 time=0.446 ms
64 bytes from 192.168.65.2: seq=1 ttl=38 time=0.287 ms
64 bytes from 192.168.65.2: seq=2 ttl=38 time=0.246 ms


/ # wget http://127.0.0.1:9909/main.go
Connecting to 127.0.0.1:9909 (127.0.0.1:9909)
wget: can't connect to remote host (127.0.0.1): Connection refused
/ # wget http://docker.for.mac.host.internal:9909/main.go
Connecting to docker.for.mac.host.internal:9909 (192.168.65.2:9909)
saving to 'main.go'
main.go              100% |********************************|   167  0:00:00 ETA
'main.go' saved


http://mirrors.163.com/centos/7/os/x86_64/Packages/
https://github.com/linuxkit/linuxkit/blob/master/docs/platform-hyperkit.md


https://unix.stackexchange.com/questions/338962/install-apk-tool-on-alpine-linux
https://dl-cdn.alpinelinux.org/alpine/v3.3/main/x86_64/

 wget http://dl-cdn.alpinelinux.org/alpine/v3.3/main/x86_64/apk-tools-static-
2.6.10-r0.apk
Connecting to dl-cdn.alpinelinux.org (151.101.110.133:80)
saving to 'apk-tools-static-2.6.10-r0.apk'
apk-tools-static-2.6 100% |********************************| 1591k  0:00:00 ETA^@
'apk-tools-static-2.6.10-r0.apk' saved


/ # ./sbin/apk.static add git
ERROR: Unable to lock database: No such file or directory
ERROR: Failed to open apk database: No such file or directory


echo http://mirror.yandex.ru/mirrors/alpine/v3.5/main > /etc/apk/repositories; 
echo http://mirror.yandex.ru/mirrors/alpine/v3.5/community >> /etc/apk/repositories

https://stackoverflow.com/questions/48736212/bad-file-descriptor-error-during-apk-update-in-docker-container-why


/ # ln ./sbin/apk.static /bin/apk

/ # apk info
WARNING: Ignoring APKINDEX.70f61090.tar.gz: Bad file descriptor
WARNING: Ignoring APKINDEX.ca2fea5b.tar.gz: Bad file descriptor

/bin/sh: can't create /etc/apk/repositories: Read-only file system

https://www.twblogs.net/a/5c2dbf03bd9eee35b3a48153


/ # cat etc/apk/repositories
http://dl-cdn.alpinelinux.org/alpine/v3.11/main
http://dl-cdn.alpinelinux.org/alpine/v3.11/community



https://dl-cdn.alpinelinux.org/alpine/v3.11/main/armv7/

wget http://dl-cdn.alpinelinux.org/alpine/v3.11/main/armv7/apk-tools-static-
2.10.8-r0.apk


/ # ln sbin/apk.static /bin/apk
/ # apk -V
apk-tools 2.10.8, compiled for armv7.

 % stty -echo -icanon && nc -U ~/Library/Containers/com.docker.docker/Data/vms/0/console.sock
docker-desktop:~#
docker-desktop:~# [38019.885752] overlayfs: upper fs does not support tmpfile.
[38024.789745] overlayfs: upper fs does not support tmpfile.
[326:15:09:15.047][I] guest: still waiting for osxfs-data after 10h33m40.000926693


https://gist.github.com/BretFisher/5e1a0c7bcca4c735e716abf62afad389


Option 1 (hard way): use netcat
nc -U ~/Library/Containers/com.docker.docker/Data/debug-shell.sock

Exit the shell with exit.

Option 2 (easier): Use nsenter in priviledged container
docker run -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh

Phil Estes (Docker Maintainer) says:

it’s running a container (using the debian image. nothing special about it other than it apparently has nsenter installed), with pid=host (so you are in the process space of the mini VM running Docker4Mac), and then nsenter says “whatever is pid 1, use that as context, and enter all the namespaces of that, and run a shell there"

Option 3 (easist): run nsenter from a pre-built image. From Justin Cormack (Docker Maintainer)
docker run -it --rm --privileged --pid=host justincormack/nsenter1



docker pull alpine:latest

https://registry.hub.docker.com/_/alpine/?tab=tags&page=1

% docker run -it --privileged --pid=host alpine:latest nsenter -t 1 -m -u -n -i sh
/ #


/ # apk add git
ERROR: Unable to lock database: Read-only file system

https://github.com/docker/for-mac/issues/2419



File sharing
Use File sharing to allow local directories on the Mac to be shared with Linux containers. This is especially useful for editing source code in an IDE on the host while running and testing the code in a container. By default the /Users, /Volume, /private, /tmp and /var/folders directory are shared. If your project is outside this directory then it must be added to the list. Otherwise you may get Mounts denied or cannot start service errors at runtime.

File share settings are:

Add a Directory: Click + and navigate to the directory you want to add.

Apply & Restart makes the directory available to containers using Docker’s bind mount (-v) feature.

https://docs.docker.com/desktop/mac/#file-sharing

https://blog.csdn.net/qq_34859327/article/details/108627777

https://github.com/docker/for-mac/issues/2243
https://github.com/moby/moby/issues/37161


 % docker run -it --privileged --pid=host alpine:latest nsenter sh
/ # apk add git
fetch https://dl-cdn.alpinelinux.org/alpine/v3.14/main/aarch64/APKINDEX.tar.gz
fetch https://dl-cdn.alpinelinux.org/alpine/v3.14/community/aarch64/APKINDEX.tar.gz
(1/7) Installing ca-certificates (20191127-r5)
(2/7) Installing brotli-libs (1.0.9-r5)
(3/7) Installing nghttp2-libs (1.43.0-r0)
(4/7) Installing libcurl (7.79.1-r0)
(5/7) Installing expat (2.4.1-r0)
(6/7) Installing pcre2 (10.36-r0)


/ # nsenter -h
nsenter: unrecognized option: h
BusyBox v1.33.1 () multi-call binary.

Usage: nsenter [OPTIONS] [PROG ARGS]

	-t PID		Target process to get namespaces from
	-m[FILE]	Enter mount namespace
	-u[FILE]	Enter UTS namespace (hostname etc)
	-i[FILE]	Enter System V IPC namespace
	-n[FILE]	Enter network namespace
	-p[FILE]	Enter pid namespace
	-U[FILE]	Enter user namespace
	-S UID		Set uid in entered namespace
	-G GID		Set gid in entered namespace
	--preserve-credentials	Don't touch uids or gids
	-r[DIR]		Set root directory
	-w[DIR]		Set working directory
	-F		Don't fork before exec'ing PROG
