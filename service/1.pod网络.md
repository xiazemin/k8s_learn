 % docker run -it --rm --privileged --pid=host alpine nsenter -t 1 -m -u -n -i sh
 / # ip neigh
192.168.65.2 dev eth0 lladdr f6:16:36:bc:f9:c6 REACHABLE
192.168.65.5 dev services1 lladdr be:23:59:87:62:76 REACHABLE
172.17.0.4 dev docker0 lladdr 02:42:ac:11:00:04 STALE
10.1.0.6 dev cni0 lladdr 2e:1e:49:a4:26:f4 REACHABLE
10.1.0.9 dev cni0 lladdr aa:b4:9f:a1:c7:4f REACHABLE
10.1.0.7 dev cni0 lladdr 92:3a:ae:3e:0b:e9 REACHABLE
172.17.0.3 dev docker0 lladdr 02:42:ac:11:00:03 STALE
192.168.65.1 dev eth0 lladdr f6:16:36:bc:f9:c6 REACHABLE
10.1.0.8 dev cni0 lladdr 0a:18:01:8b:55:02 REACHABLE
172.17.0.2 dev docker0 lladdr 02:42:ac:11:00:02 REACHABLE


/ # ip netns add ns1
/ # ip netns list
ns1
services (id: 0)

/ # ip netns exec ns1 ip link show
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: tunl0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
3: ip6tnl0@NONE: <NOARP> mtu 1452 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/tunnel6 :: brd ::

ip link add  veth-ns0 type veth peer name veth-ns1
ip link set veth-ns0 netns ns1
ip link set veth-ns1 up
ip netns exec ns1 ip addr add 172.20.1.10/24 dev veth-ns0
ip netns exec ns1 ip link set veth-ns0 up

/ # ip netns exec ns1 ping 192.168.6.160
PING 192.168.6.160 (192.168.6.160): 56 data bytes
ping: sendto: Network unreachable

/ # ip netns exec ns1 ip route add default via 172.20.1.1 dev veth-ns0

/ # ip netns exec ns1 ip route
default via 172.20.1.1 dev veth-ns0
172.20.1.0/24 dev veth-ns0 proto kernel scope link src 172.20.1.10

/ # ifconfig
eth0      Link encap:Ethernet  HWaddr 02:50:00:00:00:01
          inet addr:192.168.65.3

/ # ip link set veth-ns1 down
ip addr add 192.168.65.4/24 dev veth-ns1    
/ # ip link set veth-ns1 up //卡死了
不修改他的ip

/ # ip netns exec ns1 ping 192.168.65.3
PING 192.168.65.3 (192.168.65.3): 56 data bytes
^C
--- 192.168.65.3 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss

/ # ip netns exec ns1 ip neigh
172.20.1.1 dev veth-ns0  FAILED

1,开启了veth-ns1的arp代答:
/ # echo 1 > /proc/sys/net/ipv4/conf/veth-ns1/proxy_arp
2,把网关地址设置在对端的网卡上


/ # ifconfig veth-ns1
veth-ns1  Link encap:Ethernet  HWaddr CA:91:29:0A:BD:B8
          inet6 addr: fe80::c891:29ff:fe0a:bdb8/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:210 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:9252 (9.0 KiB)  TX bytes:936 (936.0 B)

/ # ifconfig eth0
eth0      Link encap:Ethernet  HWaddr 02:50:00:00:00:01
          inet addr:192.168.65.3  Bcast:192.168.65.255  Mask:255.255.255.0
          inet6 addr: fe80::50:ff:fe00:1/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1594534 errors:0 dropped:0 overruns:0 frame:0
          TX packets:800238 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:821072940 (783.0 MiB)  TX bytes:170037632 (162.1 MiB)

/ # ifconfig services1
services1 Link encap:Ethernet  HWaddr 0E:ED:7D:22:94:53
          inet addr:192.168.65.4  Bcast:0.0.0.0  Mask:255.255.255.255
          inet6 addr: fe80::ced:7dff:fe22:9453/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:388 errors:0 dropped:0 overruns:0 frame:0
          TX packets:390 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:45567 (44.4 KiB)  TX bytes:27970 (27.3 KiB)

192.168.65.4已经被占用了，ip冲突

/ # ip link set veth-ns1 down
/ # ip addr add 192.168.65.15/24 dev veth-ns1
/ # ip link set veth-ns1 up  //卡死了


/ # ip netns add ns0
/ # ip link set veth-ns1 netns ns0 
/ # ip netns exec ns0 ip addr add 192.168.65.4/24 dev veth-ns1
/ # ip netns exec ns0 echo 1 > /proc/sys/net/ipv4/conf/veth-ns1/proxy_arp
sh: can't create /proc/sys/net/ipv4/conf/veth-ns1/proxy_arp: nonexistent directory

/ # ip netns del ns0




/ # ip netns add ns1
/ # ip netns add ns0
/ # ip link add  veth-ns0 type veth peer name veth-ns1
/ # ip link set veth-ns0 netns ns0
/ # ip link set veth-ns1 netns ns1
/ # ip netns exec ns0 ip addr add 172.20.1.10/24 dev veth-ns0
/ # ip netns exec ns1 ip addr add 192.168.65.4/24 dev veth-ns1
/ # ip netns exec ns1 ip link set veth-ns1 up
/ # ip netns exec ns0 ip link set veth-ns0 up

/ # ip netns exec ns0 ping 192.168.65.4
PING 192.168.65.4 (192.168.65.4): 56 data bytes
ping: sendto: Network unreachable
/ # ip netns exec ns0 ip route add default via 172.20.1.1 dev veth-ns0
/ # ip netns exec ns0 ping 192.168.65.4
PING 192.168.65.4 (192.168.65.4): 56 data bytes
--- 192.168.65.4 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss

/ #  ip netns exec ns1 ls /proc/sys/net/ipv4/conf/veth-ns1/proxy_arp
/proc/sys/net/ipv4/conf/veth-ns1/proxy_arp
/ # ip netns exec ns1 echo 1>/proc/sys/net/ipv4/conf/veth-ns1/proxy_arp
sh: can't create /proc/sys/net/ipv4/conf/veth-ns1/proxy_arp: nonexistent directory
/ #  ip netns exec ns1 vi /proc/sys/net/ipv4/conf/veth-ns1/proxy_arp
/ # ip netns exec ns1 cat /proc/sys/net/ipv4/conf/veth-ns1/proxy_arp
1
/ # ip netns exec ns0 ip route
default via 172.20.1.1 dev veth-ns0
172.20.1.0/24 dev veth-ns0 proto kernel scope link src 172.20.1.10
/ # ip netns exec ns0 ip neigh
172.20.1.1 dev veth-ns0  FAILED

/ # ip netns exec ns1 ip route add default via 192.168.65.1 dev veth-ns1
/ # ip netns exec ns1 ip rout
default via 192.168.65.1 dev veth-ns1
192.168.65.0/24 dev veth-ns1 proto kernel scope link src 192.168.65.4
/ # ip netns exec ns0 vi /proc/sys/net/ipv4/conf/veth-ns0/proxy_arp
/ # ip netns exec ns0 cat /proc/sys/net/ipv4/conf/veth-ns0/proxy_arp
1
/ # ip netns exec ns1 cat /proc/sys/net/ipv4/conf/veth-ns1/proxy_arp
1

/ #  ip netns exec ns1 ip neigh
192.168.65.5 dev veth-ns1  FAILED
/ #  ip netns exec ns0 ip neigh
172.20.1.1 dev veth-ns0  FAILED


/ # ip netns exec ns0 ping 127.0.0.1
PING 127.0.0.1 (127.0.0.1): 56 data bytes
^C
--- 127.0.0.1 ping statistics ---
4 packets transmitted, 0 packets received, 100% packet loss

/ # ip netns exec ns0 ip link set lo up
/ #  ip netns exec ns0 ping 127.0.0.1
PING 127.0.0.1 (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: seq=0 ttl=64 time=0.806 ms

/ #  ip netns exec ns0 ping 172.20.1.10
PING 172.20.1.10 (172.20.1.10): 56 data bytes
64 bytes from 172.20.1.10: seq=0 ttl=64 time=0.044 ms
64 bytes from 172.20.1.10: seq=1 ttl=64 time=0.040 ms
64 bytes from 172.20.1.10: seq=2 ttl=64 time=0.052 ms

/ # ip netns exec ns1 ip link set lo up
/ # ip netns exec ns1 ping 192.168.65.4
PING 192.168.65.4 (192.168.65.4): 56 data bytes
64 bytes from 192.168.65.4: seq=0 ttl=64 time=0.045 ms
64 bytes from 192.168.65.4: seq=1 ttl=64 time=0.045 ms
64 bytes from 192.168.65.4: seq=2 ttl=64 time=0.081 ms
^C
--- 192.168.65.4 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 0.045/0.057/0.081 ms

/ #  ip netns exec ns0 arp -a
? (172.20.1.1) at <incomplete>  on veth-ns0
/ #  ip netns exec ns0 ip neigh show
172.20.1.1 dev veth-ns0  FAILED

再ping 192.168.2.1成功（由于192.168.2.1是本地IP，所以默认会走lo设备，为了避免这种情况，这里使用ping命令带上了-I参数，指定数据包走指定设备）
注意：对于非debian系统，这里有可能ping不通，主要是因为内核中的一些ARP相关配置导致veth1不返回ARP应答包，如ubuntu上就会出现这种情况，解决办法如下：

如果不设置，会导致192.168.2.1在arp缓存中状态为 arp incomplete

https://blog.csdn.net/m0_45406092/article/details/118497011


/ # ip netns exec ns0 ip link set lo down
/ #  ip netns exec ns0 ping -c 4 172.20.1.10 -I veth-ns0
PING 172.20.1.10 (172.20.1.10): 56 data bytes
^@
--- 172.20.1.10 ping statistics ---
4 packets transmitted, 0 packets received, 100% packet loss

/ # uname -a
Linux docker-desktop 5.10.104-linuxkit #1 SMP PREEMPT Wed Mar 9 19:01:25 UTC 2022 aarch64 Linux


/ # ip netns exec ns0 cat /proc/sys/net/ipv4/conf/all/rp_filter
1
/ # ip netns exec ns0 cat /proc/sys/net/ipv4/conf/veth-ns0/rp_filter
1
/ # ip netns exec ns0 cat /proc/sys/net/ipv4/conf/veth-ns0/rp_filter
0

/ #  ip netns exec ns0 ping -c 4 172.20.1.10 -I veth-ns0
PING 172.20.1.10 (172.20.1.10): 56 data bytes
^@
--- 172.20.1.10 ping statistics ---
4 packets transmitted, 0 packets received, 100% packet loss

https://blog.csdn.net/m0_45406092/article/details/118497011



rp_filter （Reverse Path Filtering）参数定义了网卡对接收到的数据包进行反向路由验证的规则。他有三个值，0、1、2，具体含意如下：

0：关闭反向路由校验
1：开启严格的反向路由校验。对每个进来的数据包，校验其反向路由是否是最佳路由。如果反向路由不是最佳路由，则直接丢弃该数据包。
2：开启松散的反向路由校验。对每个进来的数据包，校验其源地址是否可达，即反向路由是否能通（通过任意网口），如果反向路径不通，则直接丢弃该数据包。

https://www.jianshu.com/p/16d5c130670b

/ # ip netns exec ns0 vi /proc/sys/net/ipv4/conf/all/rp_filter
/ # ip netns exec ns0 cat /proc/sys/net/ipv4/conf/all/rp_filter
0
/ # ip netns exec ns0 vi /proc/sys/net/ipv4/conf/veth-ns0/rp_filter

/ # ip netns exec ns1 bash
bash-5.0# sysctl net.ipv4.conf.veth-ns1.accept_local
net.ipv4.conf.veth-ns1.accept_local = 0

bash-5.0# sysctl -w net.ipv4.conf.veth-ns1.accept_local=1
net.ipv4.conf.veth-ns1.accept_local = 1

bash-5.0# ping -c 2 192.168.65.4
PING 192.168.65.4 (192.168.65.4): 56 data bytes
64 bytes from 192.168.65.4: seq=0 ttl=64 time=0.138 ms
64 bytes from 192.168.65.4: seq=1 ttl=64 time=0.044 ms

--- 192.168.65.4 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.044/0.091/0.138 ms

bash-5.0# ping -c 2 172.20.1.10
PING 172.20.1.10 (172.20.1.10): 56 data bytes
^C
--- 172.20.1.10 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss

任何从非loopback网卡进来的任何数据包的源地址不能是本机地址

这应该算作一个设计约束，防止非法报文进来。

https://blog.csdn.net/whenloce/article/details/88083123
