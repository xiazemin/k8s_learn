运行在Node节点上的kube-proxy进程其实就是一个智能的负载均衡器，他负责把Service的请求转发到后端的某个Pod实例上， 并在内部实现服务的负载均衡与会话保持机制。
但是Service不是共用一个负载均衡器的IP地址，而是每个Service分配了一个全局唯一的虚拟IP地址，这个虚拟IP地址称为Cluster IP。这样一来，每个服务就变成了具备唯一IP地址的“通信节点” ，服务调用就变成了最基础的TCP/IP网络通信问题。 Service一旦创建， k8s就会自动为期分配一个可用的Cluster IP，而且在Service的整个生命周期内，他的Cluster IP不会发生改变。只要用Service的Name与Service的Cluster IP地址做一个DNS域名映射即可完成服务发现.

k8s通过插件的方式引入了DNS系统(CoreDNS)，把服务名作为DNS域名，这样程序就可以直接使用服务名来建立通信连接了。

理解k8s系统里面的三种IP：
Node IP： Node节点的IP地址

Node IP是k8s集群中每个节点的物理网卡IP地址，他是一个真实存在的物理网络，所有属于这个网络的服务器之间都能通过这个网络直接通信，不管他们中是否有部分节点不属于这个k8s集群，这个也表明k8s集群之外的节点访问k8s集群内的某个节点或者TCP/IP服务时，必须使用Node IP进行通信。
Pod IP： Pod的IP地址

Pod IP是每一个Pod的IP，他是Docker Engine根据docker0网桥的IP地址进行分配的，通常是一个虚拟的二层网络。k8s位于不同Node上的Pod能够直接通信，所以k8s里的一个Pod里面容器访问另一个Pod里面的容器，就是通过Pod IP所在的虚拟二层网络实现通信的，而真实的TCP/IP流量则是通过Node IP所在的物理网卡流出的。
Cluster IP： Service的IP地址,cluster ip只能在容器内访问

Cluster IP：它也是一个虚拟的IP，更像一个“伪造”的IP地址。应用内访问使用这个IP.


Service常用三种type(NodePort和LoadBalancer)
官方doc-发布服务-服务类型

ClusterIP：默认，分配一个集群内部可以访问的虚拟IP（VIP）
NodePort：在每个Node上分配一个端口作为外部访问入口
LoadBalancer：与NodePort类似,在每个节点上启用一个端口来暴露服务,除此之外,K8S会请求底层云平台(aliyun, aws等)上负载均衡器,将每个Node([NodeIP]:[NodePort])作为后端添加进去.创建LoadBalancer类型的Service会自动创建和绑定外部LoadBalancer到节点映射的NodePort上

Service DNS名称
ClusterDNS配置文件
# cat /var/lib/kubelet/config.yaml|grep -i -A1 clusterdns
clusterDNS:
- 10.80.0.10

ClusterIP A记录格式:
<service-name>.<namespace-name>.svc.cluster.local

根据svc的ip地址查询svc域名
clusterIP的Service域名解析响应的DNS记录类型是A记录.

nslookup和host命令来自bind-utils包

普通的 Service：
会生成servicename.namespace.svc.cluster.local的域名，会解析到 Service 对应的 ClusterIP 上，
在 Pod 之间的调用可以简写成 servicename.namespace，
如果处于同一个命名空间下面，甚至可以只写成 servicename 即可访问


Headless Service：
无头服务，就是把 clusterIP 设置为 None 的，会被解析为指定 Pod 的 IP 列表，同样还可以通过podname.servicename.namespace.svc.cluster.local访问到具体的某一个 Pod。


service分发策略
一种是 轮询模式
一种是会话保持模式

services由kube-proxy管理的.负载均衡默认是用的iptables;可以手动修改为ipvs.



https://www.cnblogs.com/nf01/articles/15699719.html

DNS
你可以（几乎总是应该）使用附加组件 为 Kubernetes 集群设置 DNS 服务。

支持集群的 DNS 服务器（例如 CoreDNS）监视 Kubernetes API 中的新服务，并为每个服务创建一组 DNS 记录。 如果在整个集群中都启用了 DNS，则所有 Pod 都应该能够通过其 DNS 名称自动解析服务。

例如，如果你在 Kubernetes 命名空间 my-ns 中有一个名为 my-service 的服务， 则控制平面和 DNS 服务共同为 my-service.my-ns 创建 DNS 记录。 my-ns 命名空间中的 Pod 应该能够通过按名检索 my-service 来找到服务 （my-service.my-ns 也可以工作）。

其他命名空间中的 Pod 必须将名称限定为 my-service.my-ns。 这些名称将解析为为服务分配的集群 IP。

Kubernetes 还支持命名端口的 DNS SRV（服务）记录。 如果 my-service.my-ns 服务具有名为 http　的端口，且协议设置为 TCP， 则可以对 _http._tcp.my-service.my-ns 执行 DNS SRV 查询查询以发现该端口号, "http" 以及 IP 地址。

Kubernetes DNS 服务器是唯一的一种能够访问 ExternalName 类型的 Service 的方式。 更多关于 ExternalName 信息可以查看 DNS Pod 和 Service。

